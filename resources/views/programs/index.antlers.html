<div class="relative max-w-screen-xl px-4 md:w-[90%] mx-auto py-10 overflow-hidden">
    <!-- <div class="flex flex-col-reverse md:flex-row md:gap-3 justify-center items-center shake-on-hover">
        <h1 class="font-black text-2xl md:text-3xl text-[#004f79] text-center uppercase">
            CHƯƠNG TRÌNH ĐÀO TẠO
        </h1>
        <img src="/system/mortarboard.png" class="h-14" alt="" srcset="" />
    </div> -->

    <div class="flex items-center justify-center mx-auto relative w-80 md:w-96 h-35 bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 rounded-lg">
    <div class="absolute inset-0 bg-gradient-to-r from-blue-400 via-indigo-300 to-blue-500 opacity-20"></div>
    <div class="relative z-20">
      <h1 class="text-xl md:text-3xl font-extrabold drop-shadow-md tracking-wide">CHƯƠNG TRÌNH ĐÀO TẠO</h1>
        <!-- <p class="text-base mt-2 opacity-90">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p> -->
    </div>
  <!-- Góc trên trái: Nền xanh trôi lên xuống -->
<div class="absolute top-0 left-0 w-20 h-20 bg-blue-800/30 z-10 animate-[float_6s_ease-in-out_infinite] -translate-x-8 -translate-y-8"></div>

<!-- Góc dưới trái: Xoay nhẹ -->
<div class="absolute bottom-0 left-0 w-20 h-14 bg-blue-300 opacity-50 -z-10 animate-[float_20s_linear_infinite] -translate-x-8 translate-y-8"></div>

<!-- Góc dưới phải: Nhấp nháy nhẹ -->
<div class="absolute bottom-0 right-0 w-24 h-24 bg-indigo-500 opacity-50 translate-x-8 translate-y-8 animate-[float_4s_ease-in-out_infinite] rounded-lg"></div>

<!-- Viền nhỏ góc trên trái: Xoay chậm -->
<div class="absolute top-0 left-0 w-10 h-10 border border-blue-700 opacity-30 z-[1] animate-[rotateSlow_15s_linear_infinite] -translate-x-5 translate-y-5 rotate-45"></div>

<!-- Viền lớn hơn: Trôi lên -->
<div class="absolute top-0 left-0 w-30 h-30 border border-blue-700 opacity-30 z-[1] animate-[float2_8s_ease-in-out_infinite] -translate-x-12 translate-y-12 rotate-45 rounded-md"></div>

<!-- Viền góc phải trên: Xoay chậm -->
<div class="absolute top-0 right-0 w-32 h-32 border border-indigo-500 -z-[5] animate-[rotateSlow_25s_linear_infinite] translate-x-4 -translate-y-4 rotate-45"></div>

<!-- Nền tím phía trên phải: Nhấp nháy + trôi -->
<div class="absolute top-0 right-0 w-28 h-28 bg-indigo-500 -z-10 animate-[pulseOpacity_5s_ease-in-out_infinite,float2_7s_ease-in-out_infinite] translate-x-6 -translate-y-6 rotate-45"></div>

<!-- Dưới trái: Trôi lên nhẹ -->
<div class="absolute bottom-0 left-0 w-10 h-20 bg-blue-300 opacity-30 -z-10 animate-[float2_3s_ease-in-out_infinite] translate-x-16 translate-y-8 rotate-45"></div>

<!-- Dưới phải: Xoay nhẹ -->
<div class="absolute bottom-0 right-0 w-10 h-10 bg-indigo-400 opacity-30 animate-[rotateSlow_18s_linear_infinite] -translate-x-16 translate-y-8 rotate-45"></div>

  </div>


    <div class="flex justify-between mx-2 relative z-50">
        <div id="pre-year"
            class="flex items-center justify-center h-10 w-10 hover:shadow-[1px_0_5px_-1px_#ccc] hover:text-blue-800 hover:transition-all cursor-pointer transform transition-transform duration-200 hover:-translate-x-1">
            <i class="fa-solid fa-chevron-left text-lg"></i>
        </div>
        <div id="next-year"
            class="flex items-center justify-center h-10 w-10 hover:shadow-[-2px_1px_5px_-1px_#ccc] hover:text-blue-800 hover:transition-all cursor-pointer transform transition-transform duration-200 hover:translate-x-1">
            <i class="fa-solid fa-chevron-right text-lg"></i>
        </div>
    </div>

    <div id="loading-spinner" class="hidden justify-center">
        <div class="loader"></div>
    </div>
    <div id="course-container" class="md:grid md:grid-cols-10 border-l border-t bg-white border-b border-gray-300 mt-5">
        <!-- Class Of Item -->
        <!-- <div class="col-span-2 border-r border-gray-300">
                <div class="py-3 px-5 bg-gray-100 border-b border-gray-300">
                    <div class="uppercase text-base font-semibold text-gray-500 whitespace-nowrap">
                        Khóa
                    </div>
                    <div class="w-[60px] text-3xl font-bold text-blue-800 leading-none">
                        2024
                    </div>
                </div>
                <a href="#" class="block py-3 px-5 border-b border-gray-300 group">
                    <p class="font-semibold group-hover:text-[#004f79]">
                        Chương trình
                    </p>
                    <p class="uppercase group-hover:text-blue-600">
                        Công nghệ thông tin
                    </p>
                    <span class="capitalize group-hover:text-blue-600">(đại trà)</span>
                </a>
            </div> -->
    </div>
</div>

<script>
    // Variables
    let allCourses = [];
    let offset = 0;
    let paginatedCourses = [];
    let currentPage = 0;
    const visibleCount = 5;
    const currentYear = new Date().getFullYear();
    const isMobile = window.innerWidth < 768;

    const preBtn = document.getElementById("pre-year");
    const nextBtn = document.getElementById("next-year");
    const courseContainer = document.getElementById("course-container");

    async function fetchCourses() {
        const loadingSpinner = document.getElementById('loading-spinner');
        loadingSpinner.classList.remove('hidden');
        loadingSpinner.classList.add('flex');
        try {
            const res = await fetch("/api/courses");
            if (!res.ok) throw new Error("Fetch failed");
            const courses = await res.json();

            allCourses = courses;

            paginatedCourses = createPagedCourses(allCourses, 5);

            renderProgramsByCourse();
        } catch (error) {
            console.error("Lỗi lấy dữ liệu:", err);
        } finally {
            loadingSpinner.classList.add('hidden');
            loadingSpinner.classList.remove('flex');
        }
    }

    function createPagedCourses(courses, visibleCount = 5) {
        const pages = [];
        const total = courses.length;
        const fullPages = Math.floor(total / visibleCount);
        const remainder = total % visibleCount;

        for (let i = 0; i < fullPages; i++) {
            const start = i * visibleCount;
            const sliced = courses.slice(start, start + visibleCount);
            pages.push(isMobile ? sliced : sliced.reverse());
        }

        // Nếu còn dư thì tạo 1 trang cuối với phần tử lùi về
        if (remainder > 0) {
            const lastPage = courses.slice(total - visibleCount);
            pages.push(isMobile ? lastPage : lastPage.reverse());
        }

        return pages;
    }

    function renderProgramsByCourse() {
        const currentCourses = paginatedCourses[currentPage] || [];
        // console.log(currentCourses);

        const courseListHtml = currentCourses
            .map((course) => {
                const isActive = course.year === currentYear;

                // ${!isLast ? "border-b border-gray-300" : ""}

                const programItems = course.programs
                    .map((program, index, array) => {
                        const [main, extra] = program.curriculum.title.split("(");
                        const hasExtra = !!extra;
                        const isLast = index === array.length - 1;
                        
                        return `
                    <a href="${program.url
                            }" target="_blank" class=" relative block px-3 py-2  group  overflow-hidden liquid-pulse">
                        <div class=" min-h-[110px] transform transition-transform duration-200 group-hover:scale-105 group-hover:shadow-md shadow-md p-2 text-white backdrop-blur-md border border-white/10 rounded-lg"
                         style="background-color: ${program.curriculum.background_color}">
                        <p class="font-semibold">Chương trình</p>
                        <p class="uppercase">${main.trim()}</p>
                        ${extra
                                ? `<span class="capitalize">(${extra.trim()}</span>`
                                : ""
                        }
                        </div>
                    
                    </a>
                `;
                    })
                    .join("");

                return `
             <div class="md:col-span-2 border-r border-gray-300">
            <div class="py-3 px-5 border-b border-gray-300 hover:bg-gray-200 ${isActive
                        ? "bg-blue-50 border-b border-b-blue-400"
                        : "bg-gray-100"
                    } flex justify-between items-center program-header"> 
                <div>
                <div class="uppercase text-base font-semibold text-gray-500 whitespace-nowrap">
                    Khóa
                </div>
                <div class="w-[60px] text-3xl font-bold text-blue-800 leading-none">
                   ${course.year}
                </div>
                </div>
                <div class="md:hidden toggle-down transition-transform duration-300"><i class="fa-solid fa-angle-right"></i></div>
            </div>
             <div class="program-body md:block ${isActive? "": "hidden"}">
                ${programItems}
            </div>
        </div>
        `;
            })
            .join("");

        courseContainer.innerHTML = courseListHtml;

        preBtn.classList.toggle("opacity-30", currentPage >= paginatedCourses.length - 1);
        preBtn.classList.toggle("pointer-events-none", currentPage >= paginatedCourses.length - 1);

        nextBtn.classList.toggle("opacity-30", currentPage === 0);
        nextBtn.classList.toggle("pointer-events-none", currentPage === 0);

        document.querySelectorAll('.program-header').forEach((header) => {
            header.addEventListener('click', () => {
                console.log("click", header.nextElementSibling);

                const body = header.nextElementSibling;
                const icon = header.querySelector('.toggle-down');

                if (isMobile) {
                    body.classList.toggle("hidden");
                    icon.classList.toggle("rotate-90");
                }
            })
        })
    }

    nextBtn.addEventListener("click", () => {
        currentPage--;
        // paginatedCourses[currentPage].reverse();
        courseListHtml = "";
        renderProgramsByCourse();
    });

    preBtn.addEventListener("click", () => {
        currentPage++;
        courseListHtml = "";
        renderProgramsByCourse();
    });

    fetchCourses();
</script>